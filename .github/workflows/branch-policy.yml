name: Branch Policy

on:
  pull_request:
    types:
      - opened
      - edited
      - synchronize
      - reopened
      - ready_for_review

jobs:
  enforce-prefix:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: read
    steps:
      - name: Validate branch prefix
        env:
          HEAD_REF: ${{ github.head_ref }}
          BASE_REF: ${{ github.base_ref }}
        run: |
          echo "Target branch: ${BASE_REF}"
          echo "Source branch: ${HEAD_REF}"

          if [ -z "${BASE_REF}" ] || [ -z "${HEAD_REF}" ]; then
            echo "Missing branch references. Skipping validation."
            exit 0
          fi

          case "${BASE_REF}" in
            main)
              if [[ "${HEAD_REF}" == release/* || "${HEAD_REF}" == hotfix/* ]]; then
                echo "Branch prefix valid for merge into main."
                exit 0
              fi
              echo "Only release/* or hotfix/* branches can be merged into main." >&2
              exit 1
              ;;
            develop)
              if [[ "${HEAD_REF}" == feature/* || "${HEAD_REF}" == bugfix/* ]]; then
                echo "Branch prefix valid for merge into develop."
                exit 0
              fi
              echo "Only feature/* or bugfix/* branches can be merged into develop." >&2
              exit 1
              ;;
            *)
              echo "No branch policy enforced for base ${BASE_REF}."
              exit 0
              ;;
          esac
